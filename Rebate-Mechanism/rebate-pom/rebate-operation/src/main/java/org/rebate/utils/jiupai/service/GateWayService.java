package org.rebate.utils.jiupai.service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.rebate.utils.LogUtil;
import org.rebate.utils.jiupai.pojo.JiuPaiConfig;
import org.rebate.utils.jiupai.pojo.capBatchCollection.BatchCollectionInfo;
import org.rebate.utils.jiupai.pojo.capBatchCollection.BatchCollectionReq;
import org.rebate.utils.jiupai.pojo.capBatchQuery.BatchQueryReq;
import org.rebate.utils.jiupai.pojo.capBatchTransfer.BatchTransferInfo;
import org.rebate.utils.jiupai.pojo.capBatchTransfer.BatchTransferReq;
import org.rebate.utils.jiupai.pojo.capOrderQueryReq.OrderQueryReq;
import org.rebate.utils.jiupai.pojo.capSingleTransfer.SingleTransferReq;
import org.rebate.utils.jiupai.tools.DateUtils;
import org.rebate.utils.jiupai.tools.HiDesUtils;
import org.rebate.utils.jiupai.tools.MerchantUtil;
import org.rebate.utils.jiupai.tools.RSASignUtil;

import com.alibaba.fastjson.JSON;


public class GateWayService {

	//九派配置参数
	private JiuPaiConfig config = JiuPaiConfig.getConfig();
	
    /**
     * 公共请求参数
     * @param service
     * @return
     */
    public Map<String, String> initRequestPara(String service) {
        Map<String, String> paramMap = new HashMap<String, String>();
        paramMap.put("version", config.getVersion());//版本号
        paramMap.put("charset", config.getCharset());//字符集  00:GB18030  01:GB2312  02:UTF-8  other:GBK
        //paramMap.put("encoding", getEncodingByCharset(config.getCharset()));
        //paramMap.put("requestUrl", config.getRequestUrl());
        paramMap.put("merchantId", config.getMerchantId());//商户号
        paramMap.put("requestId", DateUtils.formatYYYYMMDDHHMMSS());//请求编号
        paramMap.put("requestTime", DateUtils.formatYYYYMMDDHHMMSS());//请求时间
        paramMap.put("signType", config.getSignType());//签名类型
        paramMap.put("service", service);//请求服务类型
        return paramMap;
    }

	/**
	 * 单笔代付(capSingleTransfer)
	 * @return
	 */
	public Map<String, String> capSingleTransfer(SingleTransferReq req, String clearingSn) {
		//公共请求参数
		Map<String, String> dataMap = initRequestPara("capSingleTransfer");
		
		//业务请求参数
		String merchantId = dataMap.get("merchantId");
		String mcSequenceNo = merchantId + String.valueOf(System.currentTimeMillis());
		dataMap.put("mcSequenceNo",mcSequenceNo);//商户交易流水
		dataMap.put("mcTransDateTime",DateUtils.formatYYYYMMDDHHMMSS());//商户交易时间
		if (clearingSn == null) {
			dataMap.put("orderNo", mcSequenceNo);//订单号(针对平台提现 没有clearingSn)
		}else {
			dataMap.put("orderNo", merchantId  +  clearingSn);//订单号
		}
		dataMap.put("amount",req.getAmount());//交易金额  单位：分
		HiDesUtils hiDesUtils = new HiDesUtils();
		dataMap.put("cardNo",hiDesUtils.desEnCode(req.getCardNo()));//银行卡号  DES加密
		dataMap.put("accName",req.getAccName());//账户户名
		dataMap.put("accType","0");//账户类型   0:卡   2:对公账号
		//dataMap.put("lBnkNo",lBnkNo);//收款人开户行行号  可空（账户类型为2必输）
		//dataMap.put("lBnkNam",lBnkNam);//收款人开户行名称  可空（账户类型为2必输）
		dataMap.put("crdType","00");//银行卡类型   00:借记卡(只支持)  01:信用卡
		//dataMap.put("validPeriod",validPeriod);//有效期  如果是信用卡，该字段笔必输，格式：YYMM
		//dataMap.put("cvv2",cvv2);//如果是信用卡，该字段必输
		//ataMap.put("cellPhone",cellPhone);//手机号
		dataMap.put("remark",req.getRemark());//订单备注
		//dataMap.put("remark1",remark1);
		//dataMap.put("remark2",remark2);
		//dataMap.put("remark3",remark3);
		//dataMap.put("bnkRsv",bnkRsv);//银行附言
		//dataMap.put("capUse",capUse);//资金用途
		dataMap.put("callBackUrl", config.getNotifyUrl() + req.getCallBackUrl());
		
		return sendAndRecv(dataMap);
	}
    /**
     * 批量代付(capBatchTransfer)
     */
    public Map<String, String> capBatchTransfer(BatchTransferReq req) {
    	//公共请求参数
        Map<String, String> dataMap = initRequestPara("capBatchTransfer");
        
        //业务请求参数
        String merchantId = dataMap.get("merchantId");
        String batchNo = merchantId + String.valueOf(System.currentTimeMillis());
        dataMap.put("batchNo", batchNo);//批次号 确保统一商户唯一
        dataMap.put("count", String.valueOf(req.getCount()));
        
        List<BatchTransferInfo> infolist = req.getInfoList();
	     HiDesUtils hiDesUtils = new HiDesUtils();
	     for (int i = 0; i < infolist.size(); i++) {
        	BatchTransferInfo info = infolist.get(i);
            String sn = genSn(i);
            info.setJrnNo(batchNo + sn);//交易流水 确保同一商户唯一性
            info.setMercOrdNo(config.getMerchantId() + info.getMercOrdNo());//商户订单号 
            info.setCcy("CNY");// 币种 人民币
            info.setCardNo(hiDesUtils.desEnCode(info.getCardNo()));//银行卡号  DES加密
            info.setCardFlag("TC");//TB：对公；TC：对私
            //info.setBankKey("308100005914");//联行号  对公必填，对私可选
            info.setReqTm(DateUtils.formatYYYYMMDDHHMMSS()); //交易时间  yyyyMMddHHmmss
		}
        
        dataMap.put("infoList", JSON.toJSONString(infolist));
        
		LogUtil.debug(this.getClass(), "capBatchTransfer", "九派批量代付infolist :[%s]", JSON.toJSONString(infolist));

        return sendAndRecv(dataMap);
    }
    /**
     * 代收付批量查询(capBatchQuery)
     * @param batchNo 交易批次号
     * @return
     */
	public Map<String, String> capBatchQuery(BatchQueryReq req) {
		//公共请求参数
		Map<String, String> dataMap = initRequestPara("capBatchQuery");
		
        //业务请求参数
		dataMap.put("batchNo", req.getBatchNo());
		//dataMap.put("ordSts", "S0");//U0:预下单   P0:处理中   S0:处理成功  F0:处理失败   不传值默认是:全部
		dataMap.put("pageSize", req.getPageSize().toString());
		dataMap.put("pageNo", req.getPageNum().toString());
		
		return sendAndRecv(dataMap);
	}
	/**
	  * 订单查询(capOrderQuery)
	*/
	public Map<String, String> capOrderQuery(OrderQueryReq req) {
		 //公共请求参数
	     Map<String, String> dataMap = initRequestPara("capOrderQuery");

	     //业务请求参数
		 dataMap.put("mcSequenceNo", req.getMcSequenceNo());//商户交易流水
		 dataMap.put("mcTransDateTime", req.getMcTransDateTime());//商户交易时间
		 dataMap.put("orderNo", req.getOrderNo());//原交易订单号
		 dataMap.put("amount", req.getAmount());//原交易金额 (单位:分)
		 //dataMap.put("remark1", request.getParameter("remark1"));//可空
		 //dataMap.put("remark2", request.getParameter("remark2"));//可空			
	
	     return sendAndRecv(dataMap);
	
	}
	/**
	  * 批量代收(capBatchCollection)
	  */
	public Map<String, String> capBatchCollection(BatchCollectionReq req) {
		 //公共请求参数
	     Map<String, String> dataMap = initRequestPara("capBatchCollection");
	     
	     //业务请求参数
	     String merchantId = dataMap.get("merchantId");
	     String batchNo = merchantId + String.valueOf(System.currentTimeMillis());
	     dataMap.put("batchNo", batchNo);//批次号 确保统一商户唯一
	     dataMap.put("count", String.valueOf(req.getCount()));
	     
	     List<BatchCollectionInfo> list = req.getInfoList();
	     HiDesUtils hiDesUtils = new HiDesUtils();
	     for (int i = 0; i < list.size(); i++) {
	    	 BatchCollectionInfo info = list.get(i);
	         String sn = genSn(i);
	         info.setJrnNo(batchNo + sn);//交易流水 确保同一商户唯一性
	         info.setMercOrdNo(config.getMerchantId() + info.getMercOrdNo());//商户订单号 
	         info.setCcy("CNY");//币种 人民币
	         info.setCardNo(hiDesUtils.desEnCode(info.getCardNo()));//银行卡号  DES加密
	         info.setIdTyp("00");//00 身份证
	         info.setIdNo(hiDesUtils.desEnCode(info.getIdNo()));//银行卡号  DES加密
	         info.setReqTm(DateUtils.formatYYYYMMDDHHMMSS());
		 }
	     
	     dataMap.put("infoList", JSON.toJSONString(list));
	
	     return sendAndRecv(dataMap);
	
	}

	
	/**
	 * 发起请求并返回响应
	 * @param dataMap
	 * @return
	 */
    private Map<String, String> sendAndRecv(Map<String, String> dataMap) {
    	
    	Map<String, String> resMap = new HashMap<String, String>();
    	
    	String service = dataMap.get("service");
        String charset = dataMap.get("charset");
        String encoding = getEncodingByCharset(charset);
        //String requestUrl = dataMap.get("requestUrl");
        String merchantCertPath = config.getMerchantCertPath();
        String merchantCertPass = config.getMerchantCertPass();

        try {
        	RSASignUtil reqUtil = new RSASignUtil(merchantCertPath, merchantCertPass);
        	
            String reqData = reqUtil.coverMap2String(dataMap);
            String merchantSign = reqUtil.sign(reqData, encoding);//签名信息
            String merchantCert = reqUtil.getCertInfo();//商户证书
            
            //请求报文
            String buf = reqData + "&merchantSign=" + merchantSign + "&merchantCert=" + merchantCert;
            LogUtil.debug(this.getClass(), service, "(九派 )请求报文 :[%s]", buf);
            
            //返回报文
            String res = "";
            try {
            	MerchantUtil merchantUtil = new MerchantUtil();
            	//test
            	res = merchantUtil.sendAndRecv(config.getRequestUrl(), buf, charset);
//            	if ("capSingleTransfer".equals(service)) {
//            		res = "signType=RSA256&mcTransDateTime=20170822130323&orderSts=P&serverSign=BD487392936A903B45C82C1E4561687A4E03688E2C28D9FA5DB7521014FC2F0D78DCF8C7F036F41299F545FCDB43CE9B3FF1C31D588594A0CE1CADDC3E81C9C9E72A63A6032385A97FB7BB6FC162E5741BD9353B1C47119093F7B0E37BE9CA9E3EFB0BD3053DDFDB09CB64E652605581B8B8E84A0D5252DFDC7E915962428BE4&remark1=null&remark3=null&version=1.0&remark2=null&cardNo=2ecfee4dea9ab6cba610b9150ed58f01d8a6b4517f5bdf81&amount=321&transDate=20170822&responseId=20170822130401&transTime=130400&merchantId=800002308510001&responseTime=20170822130401&rspCode=IPS00000&requestId=20170822130323&charset=02&rspMessage=交易成功&orderNo=800002308510001201708224949&bfbSequenceNo=170703160226172133&serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&mcSequenceNo=8000023085100011503378203220";
//				}
//            	if ("capOrderQuery".equals(service)) {
//            		res = "rspCode=IPS00000&requestId=1503392189748&signType=RSA256&ordmsg=银企受理成功&charset=02&mcTransDateTime=20170822130323&serverSign=5B9B4551A1D7A3AE9C341F724F2A4D565B536D4FE5714CA0743623CFBD13F65FFBD558CAEAA10B73A231208950CAABEC6AC16E4BB912D1D19D861AE5255D9955DC61AAF05DD73C553798961D71D3C1E861C47C66B6059900CC9E9CA19838CD7EBFC19942C56A11D0EE54621E741D2BD9F67109AD39252ECCE36CE017C49B33C8&remark1=null&rspMessage=交易成功&version=1.0&remark2=null&amount=321&responseId=20170822165521&orderNo=800002308510001201708224949&bfbSequenceNo= &serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&mcSequenceNo=8000023085100011503378203220&ordsts=S&responseTime=20170822165521";
//				}
//            	if ("capBatchTransfer".equals(service)) {
//            		//批量提现（3单）
//            		//res = "rspCode=IPS00000&requestId=20170822204113&signType=RSA256&charset=02&serverSign=9AA39D55F798C5ABEA24CB51BABE14D79F8FC24AAD99D363AE8E5E075BEB36476E7AAFB705A3D49088DD8467E453ED7FE74B81FAE70B192E2B5FB2679391B08D4F500CE320387C234362465A8CF8EE76C7EEC48758EB5186DDED34142ADE2E979FE12244977A13C9455AC782E4AC29C4B74B12038BECDDEF8E1569CF275DF597&rspMessage=交易成功&version=1.0&infoList=[{\"batchNo\":\"8000023085100011503405673919\",\"jrnNo\":\"80000230851000115034056739190000\",\"mercOrdNo\":\"800002308510001201707205002\",\"ordNo\":\"170703110226173720\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503405673919\",\"jrnNo\":\"80000230851000115034056739190001\",\"mercOrdNo\":\"800002308510001201707204909\",\"ordNo\":\"170703110226173721\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503405673919\",\"jrnNo\":\"80000230851000115034056739190002\",\"mercOrdNo\":\"800002308510001201707204910\",\"ordNo\":\"170703170226173722\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"}]&responseId=a7f6e19cc5e0481b9f1404818b4297e1&serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&merchantId=800002308510001&responseTime=20170822204646";
//            		
//            		//批量货款（7单）
//            		res = "rspCode=CAP00522&requestId=20170822232711&signType=RSA256&charset=02&serverSign=09AF2B3A78D18D947B1B99D3051FCC06E09E23036B57B41AB0AE577F1AB47ABC53AE0A9F5D13540CB53B26A52ACCE0FD4E414C664B7FFED37078D5DC3B7F56710097FAC34B505FBD7F4528A4551C4E330AE5441D470A8CAE8323A9411DE0F87A8B040EBA78C2A563164C449D9EB50BA9706A1A6BF40954A75AED26C7AF1DE957&rspMessage=部分成功&version=1.0&infoList=[{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220000\",\"mercOrdNo\":\"800002308510001201708225859\",\"ordNo\":\"170703100226174145\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220001\",\"mercOrdNo\":\"800002308510001201708225858\",\"ordNo\":\"170703110226174146\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220002\",\"mercOrdNo\":\"800002308510001201708225864\",\"ordNo\":\"170703160226174147\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220003\",\"mercOrdNo\":\"800002308510001201708225863\",\"ordNo\":\"170703130226174148\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220005\",\"mercOrdNo\":\"800002308510001201708225861\",\"ordNo\":\"170703180226174149\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220006\",\"mercOrdNo\":\"800002308510001201708225860\",\"ordNo\":\"170703140226174150\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"8000023085100011503415634222\",\"jrnNo\":\"80000230851000115034156342220004\",\"mercOrdNo\":\"800002308510001201708225862\",\"errorCode\":\"CAP00530\",\"errorMsg\":\"不支持此银行卡\"}]&responseId=476d6daeb8f5467e99366d46d6803897&serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&merchantId=800002308510001&responseTime=20170822233236";
//            	}
//            	if ("capBatchQuery".equals(service)) {
//            		res = "rspCode=IPS00000&requestId=20170822223252&signType=RSA256&charset=02&serverSign=1E56A78D7678E8890202098ECA7C2EA9ED10C5D794CE93E052254D497256CB7D09144971CDE2EF1B6FC52A078C381C8EE6FEED8CFD335D913B240EE2250C36A48A6BC6C6A5BEDC20BFE79D498D4C4486B230D3CFD8F1A550B80D5D3DC339CB35115587595D2A21A2A31FF0C671B8AD49AD03FBE9F2B0531A5DB420C9690314C7&rspMessage=交易成功&version=1.0&sucessAmount=0&responseId=20170822223942&sucessNums=0&tamtCapQueryList=[{\"batchNo\":\"8000023085100011503405673919\",\"mercOrdNo\":\"800002308510001201707204910\",\"reqTm\":\"20170822204127\",\"tamTxTyp\":\"批量代付\",\"txnAmt\":\"1.2\",\"ordSts\":\"处理成功\",\"ordNo\":\"170703170226173722\"},{\"batchNo\":\"8000023085100011503405673919\",\"mercOrdNo\":\"800002308510001201707205002\",\"reqTm\":\"20170822204120\",\"tamTxTyp\":\"批量代付\",\"txnAmt\":\"2.23\",\"ordSts\":\"处理成功\",\"ordNo\":\"170703110226173720\"},{\"batchNo\":\"8000023085100011503405673919\",\"mercOrdNo\":\"800002308510001201707204909\",\"reqTm\":\"20170822204124\",\"tamTxTyp\":\"批量代付\",\"txnAmt\":\"1.7\",\"ordSts\":\"处理成功\",\"ordNo\":\"170703110226173721\"}]&nums=3&serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&totalAmount=5.13&responseTime=20170822223942";
//				}
            	//test
                
                LogUtil.debug(this.getClass(), service, "(九派 )返回报文 :[%s]", res);
                
            //} catch (IOException e) {
            } catch (Exception e) {
            	LogUtil.debug(this.getClass(), service, "(九派 )发起请求   捕获异常:%s", e.getMessage());
                e.printStackTrace();
                return null;
            }
            resMap = reqUtil.coverString2Map(res);//转换成Map
            
            //验证签名
            String verifySign = verifySign(service, resMap, encoding);
            resMap.put("verifySign", verifySign);
            

        } catch (Exception e) {
        	LogUtil.debug(this.getClass(), service, "(九派 )捕获异常:%s", e.getMessage());
            e.printStackTrace();
            return null;
        }
        return resMap;
    }
    /**
     * 验证签名
     * @param service
     * @return
     */
    private String verifySign(String service, Map<String, String> resMap, String encoding){
        //验证签名 标记
        boolean flag = false;
        String verifySign = "";
        
        RSASignUtil rsautil = new RSASignUtil();
        
        //去除null,merchantSign,serverSign,serverCert这些(不参与签名的)值，并按照字母排序
    	String sf = rsautil.coverMap2String(resMap);
        
        try {
            flag = rsautil.verify(sf, resMap.get("serverSign"), resMap.get("serverCert"), encoding);
            if (flag) {
            	LogUtil.debug(this.getClass(), service, "九派支付   验签成功");
            	verifySign = "success";
            }else {
            	LogUtil.debug(this.getClass(), service, "九派支付   验签失败");
            	verifySign = "error";
			}
		} catch (Exception e) {
			LogUtil.debug(this.getClass(), service, "九派支付   验签异常:%s", e.getMessage());
			verifySign = "exception";
		}
        return verifySign;
    }

    /**
     * 获取 编码设置
     * @param charset
     * @return
     */
    private String getEncodingByCharset(String charset){
        String encoding = "";
		if ("00".equals(charset)) {
			encoding="GB18030";
		} else if ("01".equals(charset)) {
			encoding="GB2312";
		} else if ("02".equals(charset)) {
			encoding="UTF-8";
		} else {
			encoding="GBK";
		}
		return encoding;
    }
    
    public String genSn(int i) {
        String iStr = ((Integer) i).toString();
        int len = iStr.length();
        String sn = "";
        if (len == 1) {
          sn = "000" + iStr;
        } else if (len == 2) {
          sn = "00" + iStr;
        } else if (len == 3) {
          sn = "0" + iStr;
        } else if (len == 4) {
          sn = iStr;
        } else {
          sn = "0000";
        }
        return sn;
      }
    
    public static void main(String[] args) {
//  	String sdfString = HiDesUtils.desDeCode("2cccc91b0b294634389dec244947bfa2b61353daf8529df8");   	  	
//  	String enCodeCardNo = HiDesUtils.desEnCode("6222629530005276796");
 
//    	
    	RSASignUtil resUtil = new RSASignUtil();    
    	
//    	String res = "rspCode=CAP00522&requestId=1503151383801&signType=RSA256&charset=02&serverSign=8FFDF0782ACEF81F70E926BCC9BC6C88C12237CA6A45D4C9F75F714F6AA5AC56542756AD9D241D4C1E181CE29D12BAB5BC06B50304E019B843A53D45258B503292D27B03E5149F27A4E1F2F4D6E86A08E1F71F5FB762E13DDF11686C4DDC430890BE0C926B26123FC440CA766BC2CCFD098DD5E7675EFBB162BBFE007B4FA5F7&rspMessage=部分成功&version=1.0&"
//    			+ "infoList=[{\"batchNo\":\"20170819220303\",\"jrnNo\":\"A20170819220303\",\"mercOrdNo\":\"20170819220303\",\"ordNo\":\"170703100226161429\",\"errorCode\":\"CAP00500\",\"errorMsg\":\"受理成功\"},{\"batchNo\":\"20170819220303\",\"jrnNo\":\"A20170819220303\",\"mercOrdNo\":\"20170819220303\",\"errorCode\":\"CAP00524\",\"errorMsg\":\"记录已存在\"}]"
//    					+ "&responseId=749ae314600a4a90b17b428385610597&serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&merchantId=800002308510001&responseTime=20170819220158";
    	
    	//String res = "rspCode=IPS00000&requestId=1503153491699&signType=RSA256&charset=02&serverSign=32F025CABA146CCEAF0E65449C28D3F248C0D41A12102A32E5920EBF2480744F7AB26199FEFBCF8B2BA3DA7F97156F0840A51E3B079A1501E791A3DC8421CD8769E73C601629EB2D551FF4E39FF216F1015A75CDB0A582BB3FAC5B66856EBE9FB516B274CEEE5836CFA65F2D6DB7C2ED0C219535DF8A512EE7FE92E702A32860&rspMessage=交易成功&version=1.0&sucessAmount=0&responseId=20170819223706&sucessNums=0&tamtCapQueryList=[{\"batchNo\":\"20170819220303\",\"mercOrdNo\":\"20170819220303\",\"reqTm\":\"20170819220303\",\"tamTxTyp\":\"批量代收\",\"txnAmt\":\"0.01\",\"ordSts\":\"预下单\",\"ordNo\":\"170703100226161429\"}]&nums=1&serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&totalAmount=0.01&responseTime=20170819223706";
    	
//    	String res = "rspCode=IPS00000&requestId=20170823160013&signType=RSA256&ordmsg=银企受理成功&charset=02&mcTransDateTime=20170823155612&serverSign=552AC15B355D504826D1D0C552AFE57B18233C697A20357BAE434AE83816F7A88E37F4B3989B2DD6F04B62AC087E908245010E59CD4E82A18990070D3D6A838595CD8393E98521A7423BB2D8714F4C88DF23A8B6C52E1E88ABABD1CE5FDA1B3EB5C72434A3EF83A43EA66E0585121EE7942388E6AF23EAE51B34B92988EB41D8&remark1=null&rspMessage=交易成功&version=1.0&remark2=null&amount=149&responseId=20170823155904&orderNo=800002308510001201708232424&bfbSequenceNo= &serverCert=308203653082024DA00302010202081BF6C2A9D997293C300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303131393130303530365A170D3435303131393130303530365A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100CEA9A82C9F5E6BF6AE9426EAF879CF0B8614B1C59818B841DBEE3BD44A09F03DEBD59871D975BFE42F19177342D00988A13912B153F0CC72C16EBD23C8596610F45978797414C5D211FB3DE1DA3944A8D75E7A0749EFE2E36DC46FCC42A373FFCD8F4B1C69E6D9789EEB51BF01AABE43E940652DE8F890004A965B07E49A614D0203010001A381B13081AE301D0603551D0E0416041439E6E108F96F61A1FBEA466C406666E545742BD530818C0603551D23048184308181801407C69254961EB26785D105D969445BF72CF3CCA7A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6C2A9D76A7CF2300D06092A864886F70D010105050003820101003498678C1547E2D86CCBEE81971E54221EFBDFFF85F3BAA9BB5C6EC217E02DDD48641B132BB4AAF87BE91461304F7457554465F767D29E61266DC0212F8D1DAE06743B6D62125BE989DF80B889FCA6DC25D67F28581A8C44B400D754F3B0542F56603432131E690F8FC4D632717F914A199E080FABECCD4D931EF4288330B4E9CF684409E3CA2D026EDDD4DFC473C7ADEE759E15CD2937CA95DC2F347FAE4E67257CE9941E361EBAAEC1445CB01DBE74E3BDFF62E4FF6D378C0559E4D75AD42C10B78A1999280EA9A5C3FCE22808A722D3D9C9E8929CF02D0CDB7938E30478FBE21D5F53E7A1646F3510A6A4E062748453B23620273927D0F8A3A8622714DAEB&mcSequenceNo=8000023085100011503474972665&ordsts=P&responseTime=20170823155904";
//    	Map<String, String> resMap = resUtil.coverString2Map(res);
//    	String sf = resUtil.coverMap2String(resMap);
//    	// -- 验证签名
//    	boolean flag = false;
//    	String serverSign=resMap.get("serverSign");
//    	String serverCert=resMap.get("serverCert");
//    	try {
//			flag = resUtil.verify(sf, serverSign, serverCert,"UTF-8");
//		} catch (Exception e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		}
//    	System.out.println(flag);
    	
    	String res = "idType=0&txDesc=+&signType=RSA256&validPeriod&cellPhone=+&idInfo=+&txTyp&serverSign=586EAE118B15076208D573F39D832D24643FD7D45BD5653338CE81452069BAB057E306CDF1ED0FD169E39C599103A437F21C101E35344FE412B96EE41508149FB163ED0FAA4F73753EE7372FBDD1111EA8FC46EF2CACD936C1AAC39BD91F534F24E09B525878366A0E20FF4C850E638F37790ECBE9EEB7AA1D975CEA047477DB&orderSts=S&version=1.0&amount=150&merchantId=800002308510001&reqReserved2&cvv2&reqReserved1&lBnkNo&stlMercId=800002308510001&charset=00&fee=0&accType=0&accNo=cbcd3fbcad95bd13aa6247d78e592771624dfbfff6ee702f&orderNo=800002308510001201709012433&accName=%B7%EB%B3%AC&serverCert=308203653082024DA00302010202081BF6DEF10C56066B300D06092A864886F70D0101050500305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F744341301E170D3135303433303032313730335A170D3435303433303032313730335A305A310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310E300C06035504030C05506179434130819F300D06092A864886F70D010101050003818D0030818902818100C760A3664325DBB3E7BCAAC41A9EB877A140C569762D0ECFFF388CAE1C6E1578534F3C9F6FA0B4F2BE9DBFA8AF3AAEE973DA2C9A7909FBE2790565FA9E6F1722C2F092363A40970F3B12EA35B174FAA1F1C4835DEA7DC9BDD601A34D5AF9F6A189A9E1C874F55974B33344D42B32260A364FCA759000AADF429CC09357C165790203010001A381B13081AE301D0603551D0E04160414DE7B316C2C93E2F4081D0241200578431985776230818C0603551D230481843081818014829BBF4208CC0675279B975A4D2276FBC8556467A15FA45D305B310B300906035504061302636E310B300906035504080C02626A3110300E06035504070C076265696A696E67310F300D060355040A0C064D75726F6E67310B3009060355040B0C024954310F300D06035504030C06726F6F74434182081BF6DEF10BFAB25D300D06092A864886F70D010105050003820101004BEBB7FDFC6BE8AC5DD8C3778222623801F5487C1819344870540A27D54C34951D2ED225206DCFE7097526E83DC33165381378841A9588CC2970CEC7B5D145D003322EF300DE67DF75A21C878FFA41A1AD76E2794129F4DF887B80CE1E985032CE042AEAB8F61267DDFBE06E568271B7ADBE806992BA529DE9664EB1EA16EB446BC47036E43A18F23A79B547A1963C6921DE7C38BC9D1EF15B3687EC9DDCB32AD89DAC2A15294DF8467E17C53AD5FFCC18CCDBA87EF3B23AB5DBD795CB9258E8E1258AA1F256084FB74F2969A2467F56ABD539D4DB93E65C21C354769A8DB68196BBFFECDA63BCDAEC8051F86E7825B404BB1F31901D37A65620A5111742D775&bnkRsv=+&crdType&lBnkNam";
    	System.out.println(res.replaceAll("&", "\n"));
    	System.out.println(res.indexOf("orderSts"));
    	
  	
  }



}
